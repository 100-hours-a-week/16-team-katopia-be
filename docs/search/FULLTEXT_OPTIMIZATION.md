# FULLTEXT 최적화 전략

## 0) 목적
FULLTEXT를 “도입”에서 끝내지 않고, **운영 지표 기반으로 튜닝**하기 위한 전략 설정

---

## 1) 지금 당장 봐야 하는 운영 지표 (최소 4개)

### 1. 검색 응답시간 (p95/p99)
- **왜 보나**: 사용자가 느끼는 지연의 핵심 지표.
- **어떻게 해석하나**:
  - p95/p99가 급등하면 검색 쿼리나 인덱스가 병목.
- **다음 액션**:
  - p95/p99 상승 → 인덱스 크기/토큰 크기 점검.

### 2. DB CPU/IO
- **왜 보나**: 검색이 DB 자원을 과도하게 쓰는지 판단.
- **어떻게 해석하나**:
  - CPU/IO 급증이면 풀스캔/인덱스 비효율 가능성.
- **다음 액션**:
  - `EXPLAIN`으로 FULLTEXT 인덱스 사용 여부 확인.

### 3. FULLTEXT 인덱스 크기
- **왜 보나**: 인덱스가 커질수록 읽기/쓰기 비용 증가.
- **어떻게 해석하나**:
  - 인덱스 크기 증가 → 디스크/메모리 부담 증가.
- **다음 액션**:
  - 토큰 크기(ngram_token_size) 조정 고려.

### 4. 게시글 작성/수정 지연
- **왜 보나**: FULLTEXT 인덱스는 쓰기 비용을 증가시킴.
- **어떻게 해석하나**:
  - 쓰기 지연 상승 시 인덱스 비용 과다 가능성.
- **다음 액션**:
  - 검색 인덱스 대상 칼럼 재검토.

---

## 2) 개선 포인트별 “언제/왜/무엇을 할지”

### 2-1. 토큰 크기(ngram_token_size, innodb_ft_min_token_size)
- **언제**: 2자 검색 비중이 낮고 인덱스가 과도하게 큰 경우.
- **왜**: 토큰 크기 ↑ → 인덱스 크기 ↓ → 성능 개선.
- **무엇을**: `ngram_token_size=3` 같은 조정 후 재빌드.

### 2-2. Stopword 정책
- **언제**: 검색 누락/과도한 노이즈가 보고되는 경우.
- **왜**: 의미 없는 토큰 제거/필요 토큰 유지.
- **무엇을**: 불용어 테이블 커스터마이징.

### 2-3. 랭킹 튜닝
- **언제**: 성능은 괜찮지만 결과 품질이 낮을 때.
- **왜**: score 중심 vs 최신성 가중치 균형.
- **무엇을**:
  - `score * w1 + 최신성 * w2` 형태로 정렬 개선.

### 2-4. 커서 페이징 고도화
- **언제**: 트래픽 증가 + 깊은 탐색 요구가 생길 때.
- **왜**: offset 기반 페이징의 성능 문제 해결.
- **무엇을**: score+id 기반 커서 설계.

### 2-5. 오타/초성 대응
- **언제**: 사용자 입력 품질이 낮고 검색 누락이 잦을 때.
- **왜**: FULLTEXT만으로는 형태소/오타 처리 한계.
- **무엇을**: 전처리 컬럼 또는 검색엔진 도입 검토.

### 2-6. 커밋 후 검색 반영 지연
- **언제**: “방금 쓴 글이 검색에 안 보임” 이슈가 많을 때.
- **왜**: 트랜잭션/인덱스 반영 지연.
- **무엇을**: 반영 지연 시간 측정, 지연이 큰 경우 튜닝.

---

## 3) 개선 우선순위 (초기 운영 기준)
1. **token size / stopword 튜닝**
   - 검색 누락/부분 검색 개선에 직접적
   - 효과 측정이 쉬움
2. **랭킹/정렬 튜닝**
   - 성능보다 품질 개선 목적
3. **커서 페이징 고도화**
   - 대규모 트래픽/깊은 탐색 시 효과 큼
4. **오타/초성 대응 및 검색엔진 도입**
   - 품질 향상 크지만 비용/운영 부담 큼

---

## 4) 초기 운영 체크리스트
- 검색 p95/p99 지표 확보
- DB CPU/IO 모니터링
- FULLTEXT 인덱스 크기 확인
- 게시글 쓰기 지연 확인
- 검색어 길이 분포 수집

